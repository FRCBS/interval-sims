---
title: "Dummy classifier"
author: "Jarkko Toivonen"
date: "11/4/2020"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
source("economic_effect_functions.R")
source('../../Hb_predictor_container/src/validate_stan_fit.R', chdir=T)
```

## Dummy model for females and males on Progesa data

Use the preprocessed validate dataset from random forest runs. Dummy predictor uses -previous_Hb as score for deferral. 



```{r}
load("~/FRCBS/interval-sims/rf-train-and-validate-datas.rdata", verbose=TRUE)
```

We use [Logistic function](https://en.wikipedia.org/wiki/Logistic_function) to map previous_Hb values to
the probability range [0, 1].

```{r cars}

logistic <- function(x, k=1, x0=0) 1 / (1 + exp(-k*(x-x0)))

score <- function(previous_Hb, Hb_threshold ) {
  logistic(previous_Hb, k=-0.1, x0=Hb_threshold)
}

make_threshold_conversion_data_frame <- function(Hb_threshold, k) {
  hb <- seq(110, 160, by=2)
  df <- tibble(Hb=hb, 
               Probability = logistic(hb, k=k, x0=Hb_threshold))
  return(df)
}

dummy_predictor <- function(df, Hb_threshold=NULL) {
  if (is.null(Hb_threshold)) {    # use -previous_Hb as score
    result <- tibble(Deferred = -df$previous_Hb,
                     obs = df$Hb_deferral)
  } else {                        # use logistic function of previous_Hb as score
    result <- tibble(Deferred = score(df$previous_Hb, Hb_threshold), 
                     obs = df$Hb_deferral)
    
  }
  return(result)
}

# get_metrics <- function(df, previous_Hb_threshold) {
#   df <- df %>% mutate(predicted_Hb_deferral=factor(ifelse(previous_Hb < previous_Hb_threshold, "Deferred", "Accepted"), levels=c("Accepted", "Deferred")))
#   
#   cm <- confusionMatrix(reference = df$Hb_deferral, data = df$predicted_Hb_deferral, positive = "Deferred", mode = "everything")
#   f1 <- cm$byClass["F1"]
#          #Sensitivity  = TPR
#   TPR <- cm$byClass['Sensitivity']
#   FPR <- 1 - cm$byClass['Specificity']
#   temp <- get_cost(TPR, FPR, TPR, FPR, p = parameters) # The parameters are from file economic_effect_functions.R
#   E6  <- temp$E6
#   E12 <- temp$E12
#   return(tibble(previous_Hb_threshold=previous_Hb_threshold, f1=f1, E6=E6, E12=E12))
# }
# 
# optimize_threshold <- function(df) {
#   thresholds <- seq(120, 150, by=2)
#   result <- map_dfr(thresholds, function(t) get_metrics(df, t))
#   
#   threshold <- result %>%
#     slice_max(f1) %>%
#     pull(previous_Hb_threshold)
#   return(list(threshold=threshold, result=result))
# }

```

```{r}
df1 <- make_threshold_conversion_data_frame(125, -1) 
df2 <- make_threshold_conversion_data_frame(125, -0.1)
df <- bind_rows(`k=-1`=df1, `k=-0.1`= df2, .id="k")
df %>% ggplot(aes(x=Hb, y=Probability, color=k)) + geom_point() + scale_y_continuous(breaks=seq(0, 1, by=0.1)) + labs(colour="Logistic function parameter") + ggtitle("Female")
```

```{r}
df1 <- make_threshold_conversion_data_frame(135, -1) 
df2 <- make_threshold_conversion_data_frame(135, -0.1)
df <- bind_rows(`k=-1`=df1, `k=-0.1`= df2, .id="k")
df %>% ggplot(aes(x=Hb, y=Probability, color=k)) + geom_point() + scale_y_continuous(breaks=seq(0, 1, by=0.1)) + labs(colour="Logistic function parameter") + ggtitle("Male")
```

```{r}
train_female <- train %>% filter(gender=="Women")
train_male <- train %>% filter(gender=="Men")
validate_female <- validate %>% filter(gender=="Women")
validate_male <- validate %>% filter(gender=="Men")
```

```{r}
# res_female <- optimize_threshold(train_female)
# res_male <- optimize_threshold(train_male)
```

Optimized thresholds on previous Hb for females and males
```{r}
# female_previous_Hb_threshold <- res_female$threshold
# male_previous_Hb_threshold <- res_male$threshold
# female_previous_Hb_threshold
# male_previous_Hb_threshold
```

```{r}
# res_female$result
# res_male$result
```

Final result on validate data
```{r}

# f1_female <- get_f1(validate_female, female_previous_Hb_threshold)
# f1_female
```

```{r}

# f1_male <- get_f1(validate_male, male_previous_Hb_threshold)
# f1_male
```

```{r}
prediction_female <- dummy_predictor(validate_female, 125)  # or would mean Hb be better centering point than deferral threshold
prediction_male <- dummy_predictor(validate_male, 135)

head(prediction_female)
head(prediction_male)
```

```{r}
save(prediction_female, file="~/FRCBS/interval-sims/progesa-validate-female-dummy.rdata")
save(prediction_male, file="~/FRCBS/interval-sims/progesa-validate-male-dummy.rdata")
```

```{r}
dummy_result <- process_all_data(dummy2_ids)
```

```{r}
dummy_result
```

```{r}
roc_female <- roc_wrapper(prediction_female)
pr_female <- pr_wrapper(prediction_female)
```

```{r}
roc_male <- roc_wrapper(prediction_male)
pr_male <- pr_wrapper(prediction_male)
```

```{r}
v <- c(roc_female$roc$ci[c(2,1,3)], pr_female$ci[c(1,2,3)], 
       roc_male$roc$ci[c(2,1,3)], pr_male$ci[c(1,2,3)])
aucs <- as_tibble(matrix(v, ncol=6, byrow=TRUE))
colnames(aucs) <- c("AUROC", "AUROC low", "AUROC high", "AUPR value", "AUPR low", "AUPR high")
aucs <- aucs %>% 
  mutate(Id=dummy2_ids) %>%
  select(Id, everything())

aucs
```

```{r}
dummy_result <- inner_join(aucs, dummy_result, by="Id")
dummy_result
```

