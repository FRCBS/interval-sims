---
title: "eba_sims_data"
author: "Esa Turkulainen"
date: "1/13/2020"
output: pdf_document
---

```{r setup, echo = FALSE}
setwd("~/eba_sims/src")
library(ggplot2)
library(gridExtra)
library(knitr)
library(dplyr)
library(plyr)
library(lubridate)
library(numbers)
library(data.table)
library(R.utils)
library(forecast)
source("pffunctions.R")
```

```{r load_data, echo = FALSE}
load("~/eba_sims/data/20191211CollectionAmounts.rdata")
```

## Inspect data
```{r inspect}
summary(donation10)
```

```{r filtering_function, echo = FALSE}
# Let's build a tool to filter quickly as we please
# TODO: Let the user select multiple levels for each factor
filter_donations <- function(data, 
                             donor=NULL, donation13=NULL, site=NULL,
                             date=NULL, phleb_start=NULL, status=NULL,
                             donat_phleb=NULL, Hb=NULL, gender=NULL,
                             dob=NULL, aborh=NULL, age=NULL,
                             agegroup=NULL, Hb_deferral=NULL){
  temp <- data
  if(!is.null(donor)){
    temp <- temp[temp$donor==donor,]
  }
  if(!is.null(donation13)){
    temp <- temp[temp$donation13==donation13,]
  }
  if(!is.null(site)){
    temp <- temp[temp$site==site,]
  }
  if(!is.null(date)){
    temp <- temp[temp$date > date[1] & temp$date < date[1],]
  }
  if(!is.null(phleb_start)){
    temp <- temp[temp$phleb_start==phleb_start,]
  }
  if(!is.null(status)){
    temp <- temp[temp$status==status,]
  }
  if(!is.null(donat_phleb)){
    temp <- temp[temp$donat_phleb==donat_phleb,]
  }
  if(!is.null(Hb)){
    temp <- temp[temp$Hb > Hb[1] & temp$Hb < Hb[2],]
  }
  if(!is.null(gender)){
    temp <- temp[temp$gender==gender,]
  }
  if(!is.null(site)){
    temp <- temp[temp$site==site,]
  }
  if(!is.null(dob)){
    temp <- temp[temp$dob > dob[1] & temp$dob < dob[2],]
  }
  if(!is.null(aborh)){
    temp <- temp[temp$aborh==aborh,]
  }
  if(!is.null(age)){
    temp <- temp[temp$age > age[1] & temp$age < age[2],]
  }
  if(!is.null(agegroup)){
    temp <- temp[temp$agegroup==agegroup,]
  }
  if(!is.null(Hb_deferral)){
    temp <- temp[temp$Hb_deferral==Hb_deferral,]
  }
  
  return(temp)
}
```

```{r filter_test}
# Only donat_phleb="K" and status="-"
dons <- filter_donations(data = donation10, donat_phleb = "K", status = "-")

```

```{r distribution_of_event_counts}
eventcounts <- table(dons$donor)
hist(eventcounts)
```
Sanity check: passed. (60 is the maximum number of donations in 10 years time)


```{r}
head(dons)
```

```{r}
# Function to transfrom dates to year.week 
yearweek <- function(x = Sys.Date()) {
  xday <- ISOdate(year(x), month(x), day(x), tz=tz(x))
  dn <- 1 + (wday(x) + 5)%%7
  nth <- xday + ddays(4 - dn)
  jan1 <- ISOdate(year(nth), 1, 1, tz=tz(x))
  return(sprintf("%s.%d", format(nth, "%Y"), 1 + (nth - jan1)%/%ddays(7)))
}
```


```{r}
# Order donations by date
dons <- dons[with(dons, order(date)), ]

# Transform dates to yearweeks
dons$date <- yearweek(dons$date)

# Extract first time donations
firsts <- dons[!duplicated(dons$donor),]
```

```{r}
# Check
firsts[1:20,]
```
```{r}
# Attempting vectorization of the processes below

# Firsts
first_count <- as.data.frame(table(factor(firsts$date, levels=unique(firsts$date))))
# (We needed to call factor() to retain the chronological order of the rows)
colnames(first_count) <- c("week", "firsts")

# All
all_count <- as.data.frame(table(factor(dons$date, levels=unique(dons$date))))
colnames(all_count) <- c("week", "all")
```

```{r}
# Combine into one neat df
counts_df <- data.frame(week=first_count$week, 
                        first=first_count$firsts, 
                        all=all_count$all)
```

```{r}
# Plot
ggplot(data = counts_df, aes(x=week, y=first)) + 
  geom_point(color = "dark red") +
  geom_point(aes(x=week, y=all), color = "pink") +
  theme(axis.text.x = element_text(angle = 45)) +
  geom_abline(intercept = mean(counts_df[158:520,2]), slope=0) +
  geom_abline(intercept = mean(counts_df[158:520,3]), slope=0) +
  scale_x_discrete(breaks=c("2010.1", "2011.1", "2012.1", "2013.1", "2014.1", "2015.1", "2016.1", "2017.1", "2018.1", "2019.1")) +
  theme_bw() +
  labs(title = "Number of weekly first time donations vs. all donations",
       subtitle = paste0("Each week around ", round(mean(counts_df[158:520,2])/mean(counts_df[158:520,3])*100, 2), "%", " of all donations comprise first time donors (2013 onwards)."),
       x = "Weeks",
       y = "Count") +
  annotate(geom="text", 
           x="2019.1", 
           y=mean(counts_df[158:520,2])+400, 
           label=paste0("Firsts: ", round(mean(counts_df[158:520,2]), 1))) +
  annotate(geom="text",
           x="2019.1",
           y=mean(counts_df[158:520,3])+400, 
           label=paste0("All: ", round(mean(counts_df[158:520,3]), 1)))
```

